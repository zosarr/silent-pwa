<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Gestione Sessione</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap (grafica “come prima” se usavi il componente Collapse) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-8">

        <div class="d-flex align-items-center mb-3">
          <h1 class="h4 mb-0">Gestione Sessione</h1>
        </div>

        <div class="card shadow-sm mb-3">
          <div class="card-body">
            <div class="d-flex gap-2 flex-wrap">
              <!-- AVVIA SESSIONE: rimosso data-bs-toggle/target per NON chiudere la tendina -->
              <button id="btnAvvia" type="button" class="btn btn-primary">
                Avvia sessione
              </button>

              <!-- CONFERME CORRISPONDENZA: aggiunti data-bs-toggle/target per CHIUDERE la tendina -->
              <button id="btnConferme" type="button" class="btn btn-success"
                      data-bs-toggle="collapse" data-bs-target="#scambioChiavi" aria-expanded="true" aria-controls="scambioChiavi">
                Conferme corrispondenza
              </button>

              <button id="btnAnnulla" type="button" class="btn btn-outline-secondary">
                Annulla
              </button>
            </div>
          </div>
        </div>

        <!-- SEZIONE A TENDINA: Scambio chiavi -->
        <div class="card shadow-sm">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Scambio chiavi</span>
              <!-- Indicatore stato semplice -->
              <span id="statusBadge" class="badge text-bg-secondary">In attesa</span>
            </div>
          </div>

          <!-- DEFAULT: aperta. L’id deve combaciare con data-bs-target -->
          <div id="scambioChiavi" class="collapse show">
            <div class="card-body">
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label for="algoritmo" class="form-label">Algoritmo</label>
                  <select id="algoritmo" class="form-select">
                    <option>ECDH-secp256r1</option>
                    <option>ECDH-x25519</option>
                    <option>DH-4096</option>
                  </select>
                </div>
                <div class="col-12">
                  <label for="chiavePubblica" class="form-label">Chiave pubblica (PEM)</label>
                  <textarea id="chiavePubblica" class="form-control" rows="4" placeholder="-----BEGIN PUBLIC KEY-----&#10;..."></textarea>
                </div>
              </div>

              <hr class="my-3">

              <div class="small text-muted">
                Non sarà più la pressione di <strong>Avvia sessione</strong> a chiudere questa sezione;
                la chiude <strong>Conferme corrispondenza</strong>.
              </div>
            </div>
          </div>
        </div>

        <!-- Log opzionale -->
        <div class="card shadow-sm mt-3">
          <div class="card-body">
            <pre id="log" class="mb-0 small text-body-secondary" style="white-space: pre-wrap;"></pre>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Riferimenti
    const btnAvvia = document.getElementById('btnAvvia');
    const btnConferme = document.getElementById('btnConferme');
    const btnAnnulla = document.getElementById('btnAnnulla');
    const statusBadge = document.getElementById('statusBadge');
    const logEl = document.getElementById('log');

    const log = (m) => {
      const t = new Date().toLocaleTimeString();
      logEl.textContent += `[${t}] ${m}\n`;
    };

    // Avvia sessione: NON chiude la tendina (nessun toggle Bootstrap qui)
    btnAvvia.addEventListener('click', () => {
      statusBadge.className = 'badge text-bg-info';
      statusBadge.textContent = 'Sessione avviata';
      log('Avvio sessione richiesto (la sezione Scambio chiavi resta aperta).');
      // eventuali chiamate API...
    });

    // Conferme corrispondenza: farà il toggle grazie ai data-bs- attributi sul bottone
    // Qui possiamo aggiungere solo log/stato senza occuparci del collapse manualmente.
    btnConferme.addEventListener('click', () => {
      statusBadge.className = 'badge text-bg-success';
      statusBadge.textContent = 'Corrispondenza confermata';
      log('Conferme corrispondenza inviate (sezione Scambio chiavi chiusa a tendina).');
    });

    // Annulla: riapre la tendina se era chiusa
    btnAnnulla.addEventListener('click', () => {
      const target = document.getElementById('scambioChiavi');
      const instance = bootstrap.Collapse.getOrCreateInstance(target, { toggle: false });
      instance.show();
      statusBadge.className = 'badge text-bg-secondary';
      statusBadge.textContent = 'In attesa';
      log('Operazione annullata. Sezione Scambio chiavi riaperta.');
    });
  </script>
</body>
</html>
